groups:
  - name: RED-method-recording-rules
    interval: 30s
    rules:
      - record: service:http_requests:rate5m
        expr: |
          sum by(service, status) (rate(http_requests_total[5m]))

      - record: service:http_request_errors:rate5m
        expr: |
          sum by(service) (rate(http_requests_total{status=~"5.."}[5m]))

      - record: service:http_request_error_rate:ratio
        expr: |
          sum by(service) (rate(http_requests_total{status=~"5.."}[5m])) /
          sum by(service) (rate(http_requests_total[5m]))

      - record: service:http_request_duration:p50
        expr: |
          histogram_quantile(0.50, sum by(service, le) (rate(http_request_duration_seconds_bucket[5m])))

      - record: service:http_request_duration:p90
        expr: |
          histogram_quantile(0.90, sum by(service, le) (rate(http_request_duration_seconds_bucket[5m])))

      - record: service:http_request_duration:p99
        expr: |
          histogram_quantile(0.99, sum by(service, le) (rate(http_request_duration_seconds_bucket[5m])))

  - name: node-resource-utilization
    interval: 30s
    rules:
      - record: instance:node_cpu_utilization:ratio
        expr: |
          1 - avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m]))

      - record: instance:node_memory_utilization:ratio
        expr: |
          1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)

      - record: instance:node_disk_utilization:ratio
        expr: |
          1 - (node_filesystem_avail_bytes{fstype!~"tmpfs|fuse.lxcfs|squashfs|vfat"} /
          node_filesystem_size_bytes{fstype!~"tmpfs|fuse.lxcfs|squashfs|vfat"})

      - record: instance:node_network_receive:rate5m
        expr: |
          sum by(instance) (rate(node_network_receive_bytes_total{device!~"lo"}[5m]))

      - record: instance:node_network_transmit:rate5m
        expr: |
          sum by(instance) (rate(node_network_transmit_bytes_total{device!~"lo"}[5m]))

  - name: kubernetes-resource-utilization
    interval: 30s
    rules:
      - record: namespace:container_cpu_usage:sum
        expr: |
          sum by(namespace) (rate(container_cpu_usage_seconds_total{container!=""}[5m]))

      - record: namespace:container_memory_usage:sum
        expr: |
          sum by(namespace) (container_memory_working_set_bytes{container!=""})

      - record: pod:container_cpu_usage:sum
        expr: |
          sum by(namespace, pod) (rate(container_cpu_usage_seconds_total{container!=""}[5m]))

      - record: pod:container_memory_usage:sum
        expr: |
          sum by(namespace, pod) (container_memory_working_set_bytes{container!=""})

      - record: pod:container_cpu_request:sum
        expr: |
          sum by(namespace, pod) (kube_pod_container_resource_requests{resource="cpu"})

      - record: pod:container_memory_request:sum
        expr: |
          sum by(namespace, pod) (kube_pod_container_resource_requests{resource="memory"})

      - record: pod:container_cpu_limit:sum
        expr: |
          sum by(namespace, pod) (kube_pod_container_resource_limits{resource="cpu"})

      - record: pod:container_memory_limit:sum
        expr: |
          sum by(namespace, pod) (kube_pod_container_resource_limits{resource="memory"})

  - name: cluster-level-metrics
    interval: 60s
    rules:
      - record: cluster:node_count:total
        expr: |
          count(kube_node_info)

      - record: cluster:node_cpu_capacity:sum
        expr: |
          sum(kube_node_status_capacity{resource="cpu"})

      - record: cluster:node_memory_capacity:sum
        expr: |
          sum(kube_node_status_capacity{resource="memory"})

      - record: cluster:pod_count:total
        expr: |
          count(kube_pod_info)

      - record: cluster:pod_running:count
        expr: |
          count(kube_pod_status_phase{phase="Running"})

      - record: cluster:pod_pending:count
        expr: |
          count(kube_pod_status_phase{phase="Pending"})

      - record: cluster:pod_failed:count
        expr: |
          count(kube_pod_status_phase{phase="Failed"})
