name: Validate Configuration Files

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

permissions:
  contents: read
  security-events: write

jobs:
  terraform-validate:
    name: Terraform Validation
    runs-on: ubuntu-latest
    strategy:
      matrix:
        terraform-dir:
          - terraform/cloudwatch
          - terraform/sns

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        working-directory: ${{ matrix.terraform-dir }}
        continue-on-error: false

      - name: Terraform Init
        id: init
        run: terraform init -backend=false
        working-directory: ${{ matrix.terraform-dir }}

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color
        working-directory: ${{ matrix.terraform-dir }}

  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install yamllint
        run: pip install yamllint

      - name: Run yamllint
        run: yamllint -c .yamllint.yml .

  json-validate:
    name: JSON Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate Grafana Dashboards
        run: |
          echo "Validating Grafana dashboard JSON files..."
          find grafana/dashboards -name "*.json" -type f | while read -r file; do
            echo "Validating $file"
            python3 -m json.tool "$file" > /dev/null || exit 1
          done
          echo "All Grafana dashboards are valid JSON"

      - name: Validate SLO Dashboard
        run: |
          echo "Validating SLO dashboard JSON..."
          python3 -m json.tool slo/slo-dashboard.json > /dev/null || exit 1
          echo "SLO dashboard is valid JSON"

  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install markdownlint-cli
        run: npm install -g markdownlint-cli

      - name: Run markdownlint
        run: markdownlint '**/*.md' --ignore node_modules --ignore .github
        continue-on-error: true

  placeholder-check:
    name: Check for Placeholders
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for forbidden placeholders
        run: |
          echo "Checking for placeholder strings..."
          FORBIDDEN_PATTERNS=(
            '\[Location\]'
            '\[Name\]'
            'YOUR-USERNAME'
            'YOUR_'
            'CHANGEME'
            '\[insert'
            'example\.com'
            'PLACEHOLDER'
            'TODO'
            'FIXME'
          )

          FOUND=0
          for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
            if grep -r -E "$pattern" \
              --exclude-dir=.git \
              --exclude-dir=.github \
              --exclude-dir=node_modules \
              --exclude-dir=.terraform \
              --exclude="*.tfstate*" \
              --exclude="validate.yml" --exclude="on-call-handoff-template.md" --exclude="TEMPLATE.md" \
              .; then
              echo "ERROR: Found forbidden pattern: $pattern"
              FOUND=1
            fi
          done

          if [ $FOUND -eq 1 ]; then
            echo "Placeholder check failed"
            exit 1
          fi
          echo "No placeholders found"

  quality-summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: [terraform-validate, yaml-lint, json-validate, placeholder-check]
    if: always()

    steps:
      - name: Check all validations passed
        run: |
          if [ "${{ needs.terraform-validate.result }}" != "success" ] || \
             [ "${{ needs.yaml-lint.result }}" != "success" ] || \
             [ "${{ needs.json-validate.result }}" != "success" ] || \
             [ "${{ needs.placeholder-check.result }}" != "success" ]; then
            echo "One or more validation jobs failed"
            exit 1
          fi
          echo "All validation checks passed successfully"
